#!/bin/bash

echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต Weather Bot ะฝะฐ VPS..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "ะกะบะพะฟะธััะนัะต env.example ะฒ .env ะธ ะทะฐะฟะพะปะฝะธัะต ะฟะตัะตะผะตะฝะฝัะต:"
    echo "cp env.example .env"
    echo "nano .env"
    exit 1
fi

# ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะต ะธะทะผะตะฝะตะฝะธั ะธะท git
echo "๐ฅ ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะต ะธะทะผะตะฝะตะฝะธั..."
git pull origin main

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะธ ัะดะฐะปัะตะผ ััะฐััะต ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะบะพะฝัะตะนะฝะตัั..."
docker-compose down

# ะฃะดะฐะปัะตะผ ััะฐััะต ะพะฑัะฐะทั (ะพะฟัะธะพะฝะฐะปัะฝะพ)
echo "๐งน ะัะธัะฐะตะผ ััะฐััะต ะพะฑัะฐะทั..."
docker system prune -f

# ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ
echo "๐จ ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose up -d --build

# ะะดะตะผ ะฝะตะผะฝะพะณะพ ะดะปั ะทะฐะฟััะบะฐ
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะธัะพะฒ..."
sleep 10

# ะัะพะฒะตััะตะผ ััะฐััั
echo "๐ ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose ps

# ะัะพะฒะตััะตะผ ะปะพะณะธ ะฝะฐ ะพัะธะฑะบะธ
echo "๐ ะัะพะฒะตััะตะผ ะปะพะณะธ ะฝะฐ ะพัะธะฑะบะธ..."
if docker-compose logs bot | grep -i "error\|exception\|traceback" > /dev/null; then
    echo "โ๏ธ  ะะฑะฝะฐััะถะตะฝั ะพัะธะฑะบะธ ะฒ ะปะพะณะฐั ะฑะพัะฐ!"
    docker-compose logs bot | tail -20
else
    echo "โ ะะพะณะธ ะฑะพัะฐ ะฒัะณะปัะดัั ัะธััะพ"
fi

echo "โ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo "๐ ะะพะณะธ ะฑะพัะฐ: docker-compose logs -f bot"
echo "๐ ะะพะณะธ ะะ: docker-compose logs -f postgres"
echo "๐ ะััะฐะฝะพะฒะบะฐ: docker-compose down"
echo "๐ ะะตัะตะทะฐะฟััะบ: docker-compose restart" 